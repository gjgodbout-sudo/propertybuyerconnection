import { prisma } from '@/lib/db'
import { cookies } from 'next/headers'
function isAuthorized(){ const jar=cookies(); const key=jar.get('admin_key')?.value; const secret=process.env.ADMIN_SECRET; return !!secret && key===secret }
export default async function AdminAgentsPage(){ const ok=isAuthorized(); if(!ok){ return(<div className='card'><h1 className='text-2xl font-semibold mb-2'>Admin Access Required</h1><p className='text-gray-700'>Set <code>ADMIN_SECRET</code> then visit <code>/api/admin/login?key=YOUR_SECRET</code>.</p></div>) } const agents=await prisma.agent.findMany({ orderBy:[{created_at:'desc'}], include:{ listings:true } }); return(<div className='grid gap-6'><div className='card'><div className='flex items-center justify-between'><h1 className='text-2xl font-semibold'>Agents</h1><a className='btn' href='/api/admin/logout'>Log out</a></div></div><div className='card overflow-x-auto'><table className='w-full text-sm'><thead><tr className='text-left text-gray-600'><th className='py-2'>Name</th><th>Email</th><th>Verify</th><th>Tier Lock</th><th>Status</th><th>First Active</th><th>Stripe Customer</th><th>Sub ID</th><th>Listings</th></tr></thead><tbody>{agents.map(a=>(<tr key={a.id} className='border-t'><td className='py-2'>{a.full_name}</td><td>{a.email}</td><td className='space-x-2'><form action='/api/admin/agents/verify' method='POST' className='inline'><input type='hidden' name='agent_id' value={a.id}/><input type='hidden' name='status' value='approved'/><button className='btn'>Approve</button></form><form action='/api/admin/agents/verify' method='POST' className='inline'><input type='hidden' name='agent_id' value={a.id}/><input type='hidden' name='status' value='rejected'/><button className='btn'>Reject</button></form></td><td>{a.first_active_price_tier ?? '—'}</td><td>{a.subscription_status}</td><td>{a.first_active_at ? new Date(a.first_active_at).toLocaleString() : '—'}</td><td className='truncate max-w-[180px]'>{a.stripe_customer_id ?? '—'}</td><td className='truncate max-w-[180px]'>{a.stripe_subscription_id ?? '—'}</td><td>{a.listings.length}</td></tr>))}</tbody></table></div></div>) }
