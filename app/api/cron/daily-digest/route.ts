import { NextResponse } from 'next/server'
import { prisma } from '@/lib/db'
import { sendEmail } from '@/lib/mailer'
import { sendPush } from '@/lib/push'
export const dynamic='force-dynamic'
export async function GET(){ try{ const saved=await prisma.savedSearch.findMany({ where:{ notification_pref:'daily' } }); let total=0; const sinceDefault=new Date(Date.now()-86400000); for(const ss of saved){ const since=ss.last_notified_at ?? sinceDefault; const lat=ss.lat?Number(ss.lat):null; const lng=ss.lng?Number(ss.lng):null; if(!lat||!lng) continue; const listings=await prisma.$queryRawUnsafe<any[]>(`SELECT l.* FROM listings l WHERE l.published = true AND l.published_at > $1 AND ST_DWithin(l.location, ST_SetSRID(ST_MakePoint($2,$3),4326)::geography, ($4 * 1000.0)) ORDER BY l.published_at DESC LIMIT 100`, since, Number(lng), Number(lat), ss.radius_km); if(listings.length===0) continue; const items=listings.map(l=>`• ${l.title} — ${l.city ?? ''} ${l.state_province ?? ''} — ${l.listing_url}`).join('<br/>'); const html=`<p>Daily digest: ${listings.length} new matches</p><p>${items}</p>`; const title=`Daily digest: ${listings.length} new matches`; if(ss.buyer_email){ try{ await sendEmail(ss.buyer_email, title, html) }catch(e){} } if(ss.buyer_push_json){ try{ await sendPush(ss.buyer_push_json, { title }) }catch(e){} } await prisma.savedSearch.update({ where:{ id:ss.id }, data:{ last_notified_at:new Date() } }); total++ } return NextResponse.json({ digests_sent: total }) }catch(e:any){ console.error(e); return NextResponse.json({error:'server_error',detail:e.message},{status:500}) } }
