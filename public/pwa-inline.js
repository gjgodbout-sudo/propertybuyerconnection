export async function subscribePush(){ async function getKey(){ const r=await fetch('/api/notifications/vapid-public',{cache:'no-store'}); const d=await r.json(); return d.publicKey } async function sw(){ if(!('serviceWorker' in navigator)) return null; const reg=await navigator.serviceWorker.register('/sw.js'); await navigator.serviceWorker.ready; return reg } function b64ToArr(s){ const p='='.repeat((4-(s.length%4))%4); const b=(s+p).replace(/-/g,'+').replace(/_/g,'/'); const r=atob(b); const a=new Uint8Array(r.length); for(let i=0;i<r.length;++i)a[i]=r.charCodeAt(i); return a } const reg=await sw(); if(!reg) return null; const pub=await getKey(); const sub=await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey:b64ToArr(pub)}); return sub }
